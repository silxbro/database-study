# 01. 기본 아키텍처
#### ✅ 오라클은 데이터베이스(데이터를 저장하는 파일 집합)와 이를 액세스하는 프로세스 사이에 `SGA`라고 하는 메모리 캐시 영역을 두고 있다.

- **디스크 영역보다 입출력 속도가 빠르다**
    - 디스크를 경유한 입출력은 물리적으로 액세스 암(Arm)이 움직이면서 헤드를 통해 데이터를 읽고 쓴다.
    - 메모리 캐시를 통한 입출력은 전기적 신호에 불과하기 때문에 디스크 I/O에 비교할 수 없이 빠르다.
- **많은 프로세스가 동시에 데이터를 액세스한다**
    - 사용자 데이터 보호 및 공유 메모리 영역인 SGA(System Global Area 또는 Shared Global Area)상에 위치한 데이터 구조에 대한 액세스를 직렬화하기 위함이다.
- **읽기 및 저장을 블록 단위로 수행한다**
    - GB ~ TB급 데이터를 관리하는 DBMS가 그런 식으로 데이터를 읽고 쓴다는 것은 상상하기 어려운 일이다.
- **캐시와 데이터파일 간 동기화가 주기적으로 수행된다**
    - 백그라운드에서 DBWR와 CKPT 프로세스가 캐시와 데이터파일 간 동기화를 주기적으로 수행해준다.

#### ✅ DBMS마다 데이터베이스에 대한 정의가 조금씩 다른데, 오라클에서는 디스크에 저장된 데이터 집합(Datafile, Redo Log File, Control File 등)을 `데이터베이스`(`Database`)라고 부른다
#### ✅ SGA 공유 메모리 영역과 이를 액세스하는 프로세스 집합을 합쳐서 `인스턴스`(`instance`)라고 부른다
- 프로세스 집합을 다시 **서버** 프로세스와 **백그라운드** 프로세스 집합으로 나눌 수 있다.
- 서버 프로세스는 전면에서 사용자가 던지는 명령을 처리하고, 백그라운드 프로세스는 보이지 않지만 뒤에서 묵묵히 주어진 역할을 수행한다.
- 오라클에 접속하면 각 클라이언트를 위한 전용 서버 프로세스가 떠서(Shared Server로 구성하지 않는다면) 사용자에게 필요한 서비스를 제공한다.
    - SQL을 파싱하고 필요하면 최적화를 수행하며, 커서를 열어 SQL을 실행하면서 블록을 읽고, 읽은 데이터를 정렬해서 클라이언트가 요청한 결과집합을 만들어 네트워크를 통해 전송하는 일련의 작업들을
      모두 서버 프로세스가 처리해 준다.
    - 일하는 도중에 스스로 처리하지 못하는 일들(데이터 파일로부터 DB 버퍼 캐시로 블록을 적재하거나 Dirty 블록을 캐시에서 밀어냄으로써 Free 블록을 확보하는 일, 그리고 Redo 로그 버퍼를 비우는 일 등)
      을 만나면 OS, I/O 서브시스템, 백그라운드 프로세스 등에 신호를 보내 대신 일을 처리하도록 요청한다.

#### ✅ 오라클에 접속하는 애플리케이션을 구축할 때 반드시 `커넥션 풀`(`Connection Pool`) 기능이 필요하다
- 오라클 접속 시, 리스너(Listener)에 연결요청을 하는 순간 하나의 프로세스를 띄우고(fork) PGA 메모리를 할당한다.
  이는 비용이 매우 큰 작업이므로 하나 또는 일련의 SQL 문을 수행하기 위해 매번 연결요청을 한다면 결코 성능이 좋을 리 없다.
    - **PGA** : Process(=Program=Private) Global Area의 약어로서, 서버 프로세스만을 위한 독립적인 메모리 공간이다.
      SGA(System GLobal Area)는 서버 프로세스와 백그라운드 프로세스가 공통으로 액세스하는 데이터와 제어 구조를 담는다.
    - 연결 요청 (CLIENT -> LISTENER) -> 프로세스 생성 / 연결요청 상속 (LISTENER -> SERVER) -> 메모리 생성 (SERVER -> PGA) -> RESEND 패킷 전송 (SERVER -> CLIENT) -> 연결 (CLIENT -> SERVER)
- 한번 커넥션을 맺으면 작업을 완료하더라도 이를 해제하지 않고 애플리케이션 서버에 Pooling하고 있다가 반복 재사용한다.
    - 소프트웨어 세계에서 가장 중요한 화두인 재사용성은 데이터베이스 성능 튜닝의 핵심 원리이기도 하다.

#### ✅ RAC(Real Application Cluster) 환경에서는 하나의 데이터베이스를 액세스하는 다중 인스턴스로 구성된다
- RAC 모델은 데이터파일만 공유하는 과거의 공유 디스크(Shared Disk) 방식에서 한층 더 진일보한 공유 캐시(Shared Cache) 방식을 지원한다.
    - 글로벌 캐시(Global Cache) 개념을 사용하므로 로컬 캐시(Local Cache)에 없는 데이터 블록을 이웃 노드에서 전송받아 서비스할 수 있다. 각 인스턴스를 고속의 전용 네트워크로 연결하기 때문에 가능한 일이다.
    - 심지어 다른 인스턴스에서 갱신하고 아직 커밋하지 않은 Active 상태의 블록까지도 디스크를 경유하지 않고 Dirty 버퍼(메모리와 디스크 간에 동기화되지 않은 버퍼) 상태에서 네트워크를 통해
      서로 주고받으며 갱신을 수행한다.
        - RAC 이전 OPS 환경에서는 타 노드에 캐싱된 Dirty 버퍼를 읽고자 할 때 디스크로의 쓰기 작업이 선행되어야만 했고, 이처럼 디스크를 거치는 동기화 과정을 '핑(ping)'이라고 불렀다.
- 여러 개 인스턴스가 하나의 데이터베이스를 액세스하는 것은 가능하지만, 어떤 환경에서도 하나의 인스턴스가 여러 개 데이터베이스를 액세스하는 것은 불가능하다.
- DB Link는 일반 클라이언트 세션과 동일하게 Oracle Net을 이용해 SQL 기반으로 데이터를 읽고 쓰는 구조이므로 인스턴스와 데이터베이스 관계를 설명하는 아키텍처와는 별개로 이해해야 한다.
- 참고로, 'Federated (=Distributed) Database'라고 해서 아직 DB Link로 연결하는 수준의 클러스터링 기술만을 갖고 있는 데이터베이스 제품이 대부분이다.
  여기서 RAC에 대한 내용을 깊이 있게 다루려는 것은 아니며 데이터베이스와 인스턴스에 대한 개념을 설명하기 위해 잠시 살펴보았다.

#### ✅ SQL 트레이스

```
call      count    cpu    elapsed     disk    query    current      rows
------- ------- ------- ---------- ------- -------- ---------- ---------
Parse         1    0.00       0.00       0        0          0         0
Execute 1000000   42.22      40.65     129     8381    4074523   1000000
Fetch         0    0.00       0.00       0        0          0         0
------- ------- ------- ---------- ------- -------- ---------- ---------
total   1000001   42.22      40.65     129     8381    4074523   1000000
```

SQL을 튜닝할 때 가장 많이 사용되는 툴킷(Tookkit)은 뭐니뭐니해도 SQL 트레이스라고 할 수 있는데, 위 표는 SQL 트레이스를 통해 수집된 SQL 수행정보를 TKProf 유틸리티를 이용해 포맷했을 때
볼 수 있는 Call 통계(Statistics)다.<br/>
- 2절과 3절에서 DB 버퍼 캐시를 경유한 블록 I/O 원리를 설명한다.
- 4절과 5절에서는 Redo와 Undo 메커니즘을 설명하는데, 이는 6절과 7절에서 설명하는 Consistent 모드 읽기 원리를 이해하는 데 필요한 기초 원리라고 할 수 있다.
- 6절과 7절에서는 Consistent 모드 읽기를 집중적으로 해부하고, Current 모드 읽기와의 차이점을 명확히 밝힌다.
- 8절과 9절에서 설명되는 블록 클린아웃과 Snapshot too old는 Consistent 모드 읽기 원리 때문에 부수적으로 발생하는 내부 처리방식과 현상이다.
- 10절과 11절은 대기 이벤트와 Shared Pool의 대략을 설명한다.

6절과 7절이 본 장에서 설명하려는 핵심 주제고, 이를 통해 오라클만의 독특한 읽기 일관성(Read Consistency) 모델을 이해하게 된다면 그것으로 성공이다.
나머지 내용은 대충 의미만 파악하더라도 다른 장을 이해하는 데 별 지장이 없으므로 가볍게 읽어나가기 바란다.